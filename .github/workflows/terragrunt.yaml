name: 'Terragrunt'
on:
  workflow_dispatch:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  working_dir: 'tf/deployment'
  TERRAGRUNT_PARALLELISM: 1

permissions: {}

jobs:
  pre-job:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      should_run: ${{ steps.found_paths.outputs.tf_changes == 'true' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - id: found_paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            tf_changes:
              - 'tf/**'
              - '.github/workflows/terragrunt.yaml'
              - '.mise/config.toml'

  check:
    runs-on: ubuntu-latest
    needs: [pre-job]
    if: ${{ needs.pre-job.outputs.should_run == 'true' }}
    permissions:
      contents: read
    steps:
      - name: 'Checkout'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@143a85f84a90555d121cde2ff5872e393a47ab9f # v1.0.0
        with:
          version: 2.30.3

      - uses: jdx/mise-action@13abe502c30c1559a5c37dff303831bab82c9402 # v2.2.3

      - name: Check Formatting
        run: terragrunt hclfmt --terragrunt-check --terragrunt-diff

      - name: Check terraform fmt
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_TF_DEV_ENV }}
          ENVIRONMENT: dev
        run: mise run tf fmt -diff -check

  plan:
    runs-on: ubuntu-latest
    needs: pre-job
    if: ${{ needs.pre-job.outputs.should_run == 'true' && github.ref != 'refs/heads/main' }}
    permissions:
      contents: read
    steps:
      - name: 'Checkout'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@143a85f84a90555d121cde2ff5872e393a47ab9f # v1.0.0
        with:
          version: 2.30.3

      - uses: jdx/mise-action@13abe502c30c1559a5c37dff303831bab82c9402 # v2.2.3

      - name: Plan Shared
        working-directory: ${{ env.working_dir }}/modules/shared
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_TF_PROD_ENV }}
          ENVIRONMENT: prod
        run: mise run tf plan

      - name: Plan Dev
        working-directory: ${{ env.working_dir }}/modules/scoped
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_TF_DEV_ENV }}
          ENVIRONMENT: dev
        run: mise run tf plan

      - name: Plan Prod
        working-directory: ${{ env.working_dir }}/modules/scoped
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_TF_PROD_ENV }}
          ENVIRONMENT: prod
        run: |
          mise run tf init -reconfigure
          mise run tf plan

  deploy:
    runs-on: ubuntu-latest
    needs: pre-job
    if: ${{ needs.pre-job.outputs.should_run == 'true' && github.ref == 'refs/heads/main' }}
    permissions:
      contents: read
    steps:
      - name: 'Checkout'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@143a85f84a90555d121cde2ff5872e393a47ab9f # v1.0.0
        with:
          version: 2.30.3

      - uses: jdx/mise-action@13abe502c30c1559a5c37dff303831bab82c9402 # v2.2.3

      - name: Deploy Shared
        working-directory: ${{ env.working_dir }}/modules/shared
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_TF_PROD_ENV }}
          ENVIRONMENT: prod
        run: mise run tf apply --terragrunt-non-interactive

      - name: Deploy Dev
        working-directory: ${{ env.working_dir }}/modules/scoped
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_TF_DEV_ENV }}
          ENVIRONMENT: dev
        run: mise run tf apply --terragrunt-non-interactive

      - name: Deploy Prod
        working-directory: ${{ env.working_dir }}/modules/scoped
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_TF_PROD_ENV }}
          ENVIRONMENT: prod
        run: |
          mise run tf init -reconfigure
          mise run tf apply --terragrunt-non-interactive

  success-check:
    name: Terragrunt Workflow Success
    needs: [check, plan, deploy]
    runs-on: ubuntu-latest
    permissions: {}
    if: always()
    steps:
      - uses: immich-app/devtools/actions/success-check@68f10eb389bb02a3cf9d1156111964c549eb421b # 0.0.4
        with:
          needs: ${{ toJSON(needs) }}

